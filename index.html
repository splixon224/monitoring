<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Kehadiran dan Aktivitas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="output.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        const suggestions = [
          "Mutia Zahro Utami",
          "Riva Maulina",
          "Adrio Welly Rolando",
          "Agung Pratama",
          "Dzaki Tristanto",
          "Madrufi",
          "Muhammad Attila Addarda",
          "Fatkhuroji",
          "Eki Panca Nugraha",
          "Lionel Caesar Walakandou",
          "Realdy Agsar Dwi Anggoro",
          "Dika Maryanto",
          "Suhardiansyah",
          "Annisa Rahmi",
          "Rika Jayang Sari",
          "Moch Rizal Rizky",
          "Asep Gunawan",
          "Wilorik Hamonangan Panggabean",
          "Bimo Anggoro Seno",
          "Ditha Emeralda Indyka",
          "Thoha Putra Kurnianda",
          "Ariq Hafizh Bariqi",
          "Febriyani",
          "Mohamad Alfiandy",
          "Jaya Abdullah",
          "Mikhael Ronaldo Hutapea",
          "Saidina Bima",
          "Agung Kurniawan",
          "Fahmi Nurrohman Sidiq",
          "Ananda Bagas Amarullah Tanjung",
          "Yavid Jaya Pradana",
          "Claudia Svetlana Ranti",
          "Adib Firdausi",
          "Fikram Igo Sabtu",
          "Asrul Akbar",
          "Fahrur Rozi",
          "Rasdhaty Oktaverlianda",
          "Marolop Samuel Napitupulu",
          "Dewi Mulka",
          "Bella Amalhia Sanfano Putri",
          "Lidya Devega",
          "Muhammad Raihan Mubaroq",
          "Yulia Sari",
          "Sari Rasul Putri",
          "Nechi Dwi Dianda",
          "Rahmat Fadillah",
          "Dicky Fredianto",
          "Afika Rahayu",
          "Khairun Nadya",
          "Roni Risaldi",
          "Muzammil Rabiawardana",
          "Annisaa Oceania Syaifullah",
          "Sabaril Nopri",
          "Ali Fathullah Harun",
          "Arief Firmansyah Putra",
          "Theresia Yolanda Br. Sihaloho",
          "Budi Bestara",
          "Rina Armestiani",
          "Wini Alfiani A",
        ];

        function showSuggestions(inputId, listId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            const filter = input.value.toLowerCase();

            list.innerHTML = "";

            if (filter) {
                suggestions
                    .filter(name => name.toLowerCase().includes(filter))
                    .forEach(name => {
                        const option = document.createElement("div");
                        option.textContent = name;
                        option.className = "p-2 cursor-pointer hover:bg-gray-200";
                        option.onclick = () => {
                            input.value = name;
                            list.innerHTML = "";
                        };
                        list.appendChild(option);
                    });
            }
        }

        async function isDataAlreadySubmitted(nama, date) {
            try {
                const response = await fetch("https://script.google.com/macros/s/AKfycbzGSb06xcAyG8Y6IswUJN41yYc6Plv-2coxJMdLITmDjamyOwVb5sDmq2FE9WlkodFuLQ/exec", {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });

                const result = await response.json();

                if (result && Array.isArray(result.data)) {
                    // Periksa apakah ada data yang sama dengan nama dan tanggal
                    return result.data.some(entry => entry.nama === nama && entry.date === date);
                } else {
                    console.error("Gagal memuat data dari server.");
                    return false;
                }
            } catch (error) {
                console.error("Error memeriksa data:", error);
                return false;
            }
        }

        window.handleSubmit = async (event) => {
            event.preventDefault();

            const form = document.getElementById("data-form");
            const formData = new FormData(form);
            const nama = formData.get("nama");
            const date = formData.get("date");

            // Validasi apakah data sudah pernah disubmit untuk nama dan tanggal yang sama
            const alreadySubmitted = await isDataAlreadySubmitted(nama, date);

            if (alreadySubmitted) {
                alert("Data sudah pernah disubmit pada hari ini.");
                return; // Hentikan proses submit
            }

            // Tambahkan timestamp saat ini
            const timestamp = new Date().toISOString();

            // Tambahkan timestamp ke data
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            data.timestamp = timestamp; // Tambahkan properti timestamp

            try {
                const response = await fetch("https://script.google.com/macros/s/AKfycbzGSb06xcAyG8Y6IswUJN41yYc6Plv-2coxJMdLITmDjamyOwVb5sDmq2FE9WlkodFuLQ/exec", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (result.result === "success") {
                    alert("Data berhasil disimpan ke Google Spreadsheet!");
                    form.reset();
                } else {
                    console.error(result.error);
                    alert("Terjadi kesalahan saat menyimpan data.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Gagal mengirim data. Silakan coba lagi.");
            }
        };

        window.updateSection = function () {
            const hadir = document.getElementById('hadir').checked;
            const section2 = document.getElementById('section-2');
            const section3 = document.getElementById('section-3');
            const aktivitas = document.getElementById('aktivitas');
            const remark = document.getElementById('remark');
            const cutiRadio = document.getElementById('cuti');
            const sakitRadio = document.getElementById('sakit');
            const izinRadio = document.getElementById('izin');

            section2.classList.toggle('hidden', !hadir);
            section3.classList.toggle('hidden', hadir);

            if (hadir) {
                aktivitas.setAttribute('required', 'true');
                remark.removeAttribute('required');
                cutiRadio.removeAttribute('required');
                sakitRadio.removeAttribute('required');
                izinRadio.removeAttribute('required');
            } else {
                remark.setAttribute('required', 'true');
                cutiRadio.setAttribute('required', 'true');
                sakitRadio.setAttribute('required', 'true');
                izinRadio.setAttribute('required', 'true');
                aktivitas.removeAttribute('required');
            }
        };

        window.onload = function () {
            const dateInput = document.getElementById('date-input');
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');

            dateInput.value = `${yyyy}-${mm}-${dd}`;
            dateInput.max = `${yyyy}-${mm}-${dd}`;
        };
    </script>
</head>
<body class="bg-purple-100 p-4">
    <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md">
        <div class="bg-blue-300 text-white p-4 rounded-t-lg">
            <h1 class="text-2xl font-bold mt-2">Daily Activity BPR R3</h1>
            <p class="mt-1">Monitoring daily activity tester BPR R3</p>
            <blockquote class="mt-4 italic border-l-4 border-gray-300 pl-4">
              "Omnis responsibilitas in manibus meis."
            </blockquote>
        </div>
        <form id="data-form" class="p-4 space-y-6" onsubmit="handleSubmit(event)">
            <div>
                <label for="nama" class="block text-sm font-medium text-gray-700">Nama Lengkap<span class="text-red-500">*</span></label>
                <input
                    type="text"
                    id="nama"
                    name="nama"
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                    placeholder="Masukkan nama"
                    oninput="showSuggestions('nama', 'nama-suggestions')"
                    required>
                <div id="nama-suggestions" class="mt-1 bg-white shadow-lg rounded-md max-h-60 overflow-auto"></div>
            </div>
            <div>
                <label for="date" class="block text-sm font-medium text-gray-700">Tanggal</label>
                <input
                    type="date"
                    id="date-input"
                    name="date"
                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                    required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Hadir</label>
                <input type="checkbox" id="hadir" class="mr-2" onclick="updateSection()">
                <label for="hadir">Ya, hadir</label>
            </div>
            <div id="section-2" class="hidden">
                <label for="aktivitas" class="block text-sm font-medium text-gray-700">Aktivitas</label>
                <input type="text" id="aktivitas" name="aktivitas" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
            </div>
            <div id="section-3" class="hidden">
                <label class="block text-sm font-medium text-gray-700">Alasan (Jika Tidak Hadir)</label>
                <input type="text" id="remark" name="remark" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700">Jenis Ketidakhadiran</label>
                    <input type="radio" id="cuti" name="absence-type" value="Cuti"> <label for="cuti">Cuti</label>
                    <input type="radio" id="sakit" name="absence-type" value="Sakit"> <label for="sakit">Sakit</label>
                    <input type="radio" id="izin" name="absence-type" value="Izin"> <label for="izin">Izin</label>
                </div>
            </div>
            <button type="submit" class="mt-4 w-full bg-blue-500 text-white py-2 px-4 rounded-md shadow-md hover:bg-blue-700">Submit</button>
        </form>
    </div>
</body>
</html>
